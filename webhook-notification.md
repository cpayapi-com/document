# Webhook Notification

[Home](https://github.com/cpayapi-com/document/blob/main/README.md) /
_Webhook Notification_


## Table of Contents

- [Introduction](#introduction)
- [How to Configure the Notification Endpoint](#how-to-configure-the-notification-endpoint)
- [Notification Retry Mechanism](#notification-retry-mechanism)
- [Notification Method and Data](#notification-method-and-data)
  - [Method](#method)
  - [Data](#data)
  - [Expected Response](#expected-response)
  - [Request Demo](#request-demo)


## Introduction
When the order status changes, the merchant will be notified and can take action accordingly.  
The bellowing is the event list when we send the webhook:

| Order Status | Description |
| :---- | :---- |
| 14 | User payment is successful  |
| 15 | User payment failed |


## How to Configure the Notification Endpoint
- Posted to parameter `callBackURL` when the checkout endpoint called.
- Navigate to `User Center / User Center / Basic Information / Callback URL of a successful payment`, 
  and configure it in `Merchant System`.

## Notification Retry Mechanism

| Attempt | Interval (in minutes) |
| :---- | :---- |
| 1 | 0  |
| 2 | 1 |
| 3 | 3 |
| 4 | 9 |
| 5 | 27 |
| 6 | 81 |
| 7 | 243 |
| 8 | 729 |
| 9 | 2187 |

## Notification Method and Data

### Method
HTTP POST
> Content-Type: application/x-www-form-urlencoded

### Data
| Field | Type | Description |
| :---- | :---- | :---- |
|merchantId | int64  | the unique id generated by CPay  |
|merchantTradeNo  | string  | the unique id of transaction generated by merchant |
|merchantUserId  | string  | the unique id of user generated by merchant |
|orderId  | string  | the unique id of transaction generated by CPay |
|orderStatus  | int | see details [here](https://github.com/cpayapi-com/document/blob/main/api-reference/order-status.md) |
|orderAmount  | string | amount paid by the user  |
|receivedAmount  | string | amount received by merchant's account for this transaction  |
|serviceFee  | string | commission amount charged by CPay |
|actualAmount  | string | ~~deprecated~~  |
|fee  | string | ~~deprecated~~, replace by `serviceFee`  |
|currency  | string | e.g. USD,EUR,GBP etc.|
|cryptoCurrency  | string | ~~deprecated~~, only works for CryptoCurrency |
|network  | string | ~~deprecated~~, only works for CryptoCurrency |
|hash  | string | ~~deprecated~~, only works for CryptoCurrency |
|remark  | string | description of the order status |
|createTime  | int64 | transaction created time in CPay (millisecond) |
|sign  | string | for data security, generate by [algorithm](https://github.com/cpayapi-com/document/blob/main/api-reference/signature.md) |

> Note: `orderAmount` = `receivedAmount` + `serviceFee`


### Expected Response
CPay webhook service experts the only two response values in a TEXT, not a JSON or others.
- `success`
- `fail`

> If `fail` or an empty string is received, webhook service will retry later.

### Request Demo
```shell
curl -X POST '{callback URL of merchant}' \
-H 'Content-Type: application/x-www-form-urlencoded' \
-d 'param={JSON String}'

```

JSON data example:  
- **Success**
```shell
{
  "merchantId": 2000001, 
  "merchantTradeNo": "M100002",
  "merchantUserId": "UID12345",
  "orderId": "23033112345965", 
  "cryptoCurrency": "USD",
  "currency": "USD",
  "serviceFee": "1.01",
  "fee": "1.01",
  "orderAmount": "22.33",
  "receivedAmount": "21.32",
  "actualAmount": "22.33",
  "orderStatus": 14, 
  "network": "TRON(TRC-20)",
  "hash": "0x8bd283cf44643e66a1bbe64817ca593f18dbf78d5ce8a725bc29bf", 
  "remark": "success", 
  "createTime": 1685758334422,
  "sign": "9aa9b34e950061f1bb1e9ccd6fadcedab8e354f6"
}

{
  "merchantId": 2000001, 
  "merchantTradeNo": "M100002",
  "merchantUserId": "UID12345",
  "orderId": "23033112345965", 
  "cryptoCurrency": "USD",
  "currency": "USD",
  "serviceFee": "1.01",
  "fee": "1.01",
  "orderAmount": "22.33",
  "receivedAmount": "21.32",
  "actualAmount": "22.33",
  "orderStatus": 14, 
  "network": "",
  "hash": "", 
  "remark": "success", 
  "createTime": 1685758334422,
  "sign": "9aa9b34e950061f1bb1e9ccd6fadcedab8e354f6"
}
```

- **Failure**
```shell
{
  "merchantId": 2000001, 
  "merchantTradeNo": "M100002",
  "merchantUserId": "UID1234x", 
  "orderId": "23033112345965", 
  "cryptoCurrency": "USD",
  "currency": "USD",
  "serviceFee": "1.01",
  "fee": "1.01",
  "orderAmount": "22.33",
  "receivedAmount": "21.32",
  "actualAmount": "22.33",
  "orderStatus": 15, 
  "network": "",
  "hash": "", 
  "remark": "Payment Abandoned", 
  "createTime": 1685758334422,
  "sign": "9aa9b34e950061f1bb1e9ccd6fadcedab8e354f6"
}
```
